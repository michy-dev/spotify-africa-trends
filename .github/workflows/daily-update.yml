name: Daily Pipeline Update

on:
  schedule:
    # Run at 4 AM UTC (6 AM SAST)
    - cron: '0 4 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-trends:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger unified refresh (pipeline + trendjack)
        run: |
          response=$(curl -s -X POST \
            "https://spotify-africa-trends.fly.dev/api/refresh?secret=${{ secrets.PIPELINE_SECRET }}&modules=all&markets=NG,KE,GH,ZA" \
            -H "Content-Type: application/json")
          echo "Response: $response"
          if echo "$response" | grep -q '"status"'; then
            echo "Refresh triggered successfully!"
            echo "$response" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Status: {d.get(\"status\", \"unknown\")}')"
          else
            echo "Failed to trigger refresh"
            exit 1
          fi

      - name: Wait for data to settle
        run: sleep 60  # Wait 1 minute

      - name: Health check
        run: |
          curl -f https://spotify-africa-trends.fly.dev/health || exit 1
          echo "Dashboard is healthy!"

      - name: Check data health
        run: |
          health=$(curl -s https://spotify-africa-trends.fly.dev/api/data-health)
          echo "Data health: $health"

      - name: Check module counts
        run: |
          # Check each module
          spikes=$(curl -s "https://spotify-africa-trends.fly.dev/api/artist-spikes/NG")
          echo "Artist Spikes NG: $(echo $spikes | python3 -c 'import sys,json; print(json.load(sys.stdin).get(\"count\", 0))')"

          signals=$(curl -s "https://spotify-africa-trends.fly.dev/api/style-signals")
          echo "Style Signals: $(echo $signals | python3 -c 'import sys,json; print(json.load(sys.stdin).get(\"count\", 0))')"

          cards=$(curl -s "https://spotify-africa-trends.fly.dev/api/pitch-cards/NG")
          echo "Pitch Cards NG: $(echo $cards | python3 -c 'import sys,json; print(json.load(sys.stdin).get(\"count\", 0))')"
